\documentclass{article}
\newcommand{\Cov}{\emph{Cov} }
\newcommand{\affineA}{(affine ?)}
\newcommand{\Cover}{\emph{Cov}er }
\newcommand{\truncation}{$\bT$runcation}
%\newcommand{\Atl}{\emph{Atlas}}
\usepackage{graphicx} % Required for inserting images
\newcommand{\red}[1]{{\color{red} #1}}
\newcommand{\St}{\mathsf{St}}
\newcommand{\CS}{\mathsf{CS}}
\newcommand{\Zar}{\mathsf{Zar}}
\newcommand{\Aff}{\mathsf{Aff}}
\include{preamble}

\renewcommand{\GS}{\mathsf{GS}}
\title{Thesis}
\author{Tim Lichtnau }
\date{May 2024}

\begin{document}
\newtheorem*{warning}{Warning}
\newtheorem*{why}{Why I did it this way}
\newtheorem*{think}{Think about}
\maketitle
\include{Atlas}

\section{Preparation}


\begin{lemma}{\label{lemma:havingAbstractAtlasClosedUnderId}}
	Let $C$ be a class of types stable under $\sum$. %HOPE WE DONT NEED (because we want to apply it to \cV = covering stacks) finite limits, i.e. containing 1, stable under dependent sums and finite limits
	The class $\mathsf{HasAtlas}_C$ of types $Y$ which admit a map $\Aff \ni S \to Y$ fibered in $C$ is stable under identity types. %.  If it contains $C$ and is closed under dependent sums, then it is closed under taking identity types.
\end{lemma}
\begin{proof}
%	Obviously 1 has an atlas, and the class of types admitting an atlas is stable by $\sum$ by \ref{thm:atlasStableSum}.
%	It remains to show, that identity types in $Y$ have an atlas provided that $Y$ has an atlas.
	
	%This is a special case of stability under dependent sums. But lets prove it anyway.
	By assumption we can choose a map $\Aff \ni V \overset{p}{\to} Y$ fibered in $C$. Let $y,y' : Y$.  Then we have the map
	\begin{align*}
		(\fib_p y) \times_V (\fib_p y') &\to y = y' \\
		(v , q : y = p v) , (v', q' : y' = p v') , (h : v = v') &\mapsto q \cdot h \cdot q'^{-1}
	\end{align*}
	
	The fiber over $j : y = y'$ looks like  %because $y$ and $y'$ are free we may only show the statement for the fiber over the path  $\mathsf{refl}_y : y = y$. 
	\[
	\sum_{v}  ( \underbrace{\sum_{v'} (h : v = v')}_{\mathsf{isContr}}) \times (q : y = p v) \times (q'  : y' = p v') \times (q \cdot h \cdot q'^{-1} = j) \simeq \sum_v (v = py) \simeq \fib_p y
	\]
	Hence the map is fibered in $C$. It suffices to show, that	$(\fib_p y) \times_V (\fib_p y')$ has an atlas, because then we can compose such an atlas with the above map to obtain an atlas of $y = y'$.
	By assumption the fibers of $p$ have an atlas, so we can choose $q : W \to \fib_p y, q' : W' \to \fib_p y'$ atlasses. Then $W \times_V W' \to (\fib_p y) \times_V (\fib_p y')$ is an atlas: The domain is a fiber product of types in $\Aff$, hence it belongs to $\Aff$. The fiber over $(x,x')$ is equivalent to the product of fibers $(\fib_q x) \times (\fib_{q'} x')$ which is in $C$ by stability under dependent sums (so in particular under finite products).
	
\end{proof}
\begin{lemma}{\label{lemma:AtlasSum}}
	Let $\cU' \subset \cU$ be stable under dependent sums.
	Let $X$ be a type with a  map $p : U \to X$ fibered in $\cU'$.  For any $x : X$, let $Y_x$ be a type and moreover for any $u : U$, we are given a map $q_u : V_u \to Y_{p(u)}$ fibered in $\cU'$. Then the induced map
	\[
	p : \sum_{u : U} V_u \to \sum_{x : X} Y_{x}
	\]
	is fibered in $\cU'$
\end{lemma}
\begin{proof}
	The fiber of $p$ over some $(x,y) \in \sum_{x :X} Y_x$ is given by
	\[
	\sum_{u : \fib_p x} \fib_{q_u} (y') 
	\]
	where $y' : Y_{p(u)}$ (depending on $u$) is the transport of $y : Y_x$ along $x = p(u)$. As $\cU'$ is stable under dependent sum %(\ref{lemma:LexSumStable}, \ref{lemma:LexStability}), 
	those fibers are again in $\cU'$. This shows the result.
\end{proof}
\include{LexModalities}
\include{LocalChoice}
\include{Stacks}
\include{Descent}
\include{SaturatedTopology}


\include{GeomPropositions}
\include{FundamentalThmAlgSpc}
\include{AlgebraicSpace}



\section{Local properties}

\begin{definition}
	Let $\cV \subset \cU$ a subclass of types be stable under finite limits. 
	We call a property $P$ of morphisms of types in $\cV$ local, if 
	\begin{enumerate}
		\item its satisfied by identities in $\cV$,
		\item stable under composition 
		\item Given $X,Y,Z,W \in \cV$. if $Y \to W$ is a geometric cover , then 
			% https://q.uiver.app/#q=WzAsNCxbMCwwLCJYIl0sWzAsMSwiWSJdLFsxLDEsIlciXSxbMSwwLCJaIl0sWzAsM10sWzAsMSwiZiciLDJdLFsxLDJdLFszLDIsImYiXSxbMCwyLCIiLDEseyJzdHlsZSI6eyJuYW1lIjoiY29ybmVyLWludmVyc2UifX1dXQ==
			\[\begin{tikzcd}
				X & Z \\
				Y & W
				\arrow[from=1-1, to=1-2]
				\arrow["{f'}"', from=1-1, to=2-1]
				\arrow["\ulcorner"{anchor=center, pos=0.125}, draw=none, from=1-1, to=2-2]
				\arrow["f", from=1-2, to=2-2]
				\arrow[from=2-1, to=2-2]
			\end{tikzcd}\]
		$f$ has $P$ iff $f'$ has $P$.
		\item
	Given a commutative triangle in $\cV$% https://q.uiver.app/#q=WzAsMyxbMCwwLCJYIl0sWzEsMCwiWSJdLFsxLDEsIloiXSxbMCwxLCJmIl0sWzEsMiwiZyJdLFswLDIsImgiLDJdXQ==
	\[\begin{tikzcd}
		X & Y \\
		& Z
		\arrow["f", from=1-1, to=1-2]
		\arrow["h"', from=1-1, to=2-2]
		\arrow["g", from=1-2, to=2-2]
	\end{tikzcd}\]
with $X \to Y$ a geometric cover. Then $h$ has $P$ iff $g$ has $P$
\end{enumerate}
\begin{lemma}{\label{lemma:local}}
	If $P$ is local, then 
	\begin{itemize}
		\item geometric covers have P
		\item in Point 3, The statement 'If $f'$ has $P$ then $f$ has $P$' is automatic by Point 4.
	\end{itemize}
\end{lemma}
\end{definition}
\begin{lemma}
	Beeing a geometric cover is local.
\end{lemma}
\begin{proof}
	Reduce to the case of $Z = 1$. If $X \to Y$ is a geometric cover, then $X$ is a covering stack iff $Y$ is a covering stack by stability under quotients and under sums. If both are coverings stacks, then the fibers 
\end{proof}

\begin{lemma}{\label{lemma:atlasOfMap}}
    Let $P$ be a local property of morphisms of geometric stacks. For
    A morphism between geometric stacks $f : X \to Y$  TFAE 
    \begin{enumerate}
    	\item $f$ has $P$

    	\item For any Atlas $\Spec A \to Y$ and any atlas $S \to X \times_Y \Spec A$ the composite $S \to \Spec A$ has $P$
	    \item $f$ has an atlas that has $P$.
    \end{enumerate}
\end{lemma}
\begin{proof}
\begin{itemize}
	\item [1 $\Rightarrow$ 2]
	Given a geometric atlas $\Spec A \to Y$ and taking the pullback % https://q.uiver.app/#q=WzAsNCxbMCwwLCJYIFxcdGltZXNfWSBcXFNwZWMgQSJdLFswLDEsIlgiXSxbMSwwLCJcXFNwZWMgQSJdLFsxLDEsIlkiXSxbMSwzLCJmIl0sWzAsMiwiZiciXSxbMiwzXSxbMCwxXV0=
	\[\begin{tikzcd}
		{X \times_Y \Spec A} & {\Spec A} \\
		X & Y
		\arrow["{f'}", from=1-1, to=1-2]
		\arrow[from=1-1, to=2-1]
		\arrow[from=1-2, to=2-2]
		\arrow["f", from=2-1, to=2-2]
	\end{tikzcd}\]
$f'$ has $P$ as a basechange of $f$ along a geometric cover. Given a geometric atlas $S \to X \times_Y \Spec A$, it will have $P$, the composition $S \to \Spec A$ will be in $P$.
\item [2 $\Rightarrow$ 3]
$Y$ is a geometric stack, hence admits some geom atlas $\Spec A \to Y$. Again, $X \times_Y \Spec A$ is a geometric stack hence admits a geometric atlass.
\item [3 $\Rightarrow$ 1]
	If we have an atlas $\tilde f : \tilde X \to \tilde Y$, then $\tilde X \to \tilde Y \to Y$ has $P$ by stability under composition. Then by (4) $X \to Y$ has $P$, as $\tilde X \to X$ is a geometric cover \\

\end{itemize}
\end{proof}

So we may extend algebraic notions of maps to all geometric stacks:
\begin{definition}
	Let $P$ be a property of morphisms local in affine schemes.
	
	 We define a morphism of geometric stacks $f : X \to Y$ to have $P$ iff
	there exist atlasses and a $P$-map on affines 
	% https://q.uiver.app/#q=WzAsNCxbMCwwLCJcXFNwZWMgQSJdLFswLDEsIlgiXSxbMSwxLCJZIl0sWzEsMCwiXFxTcGVjIEIiXSxbMywyXSxbMCwxXSxbMSwyLCJmIiwxXSxbMCwzLCJcXGhhdCBmIiwwLHsic3R5bGUiOnsiYm9keSI6eyJuYW1lIjoiZGFzaGVkIn19fV1d
	\[\begin{tikzcd}
		{\Spec A} & {\Spec B} \\
		X & Y
		\arrow["{\hat f}", dashed, from=1-1, to=1-2]
		\arrow[from=1-1, to=2-1]
		\arrow[from=1-2, to=2-2]
		\arrow["f"{description}, from=2-1, to=2-2]
	\end{tikzcd}\]
\end{definition}
\begin{lemma}
	Let $P$  be a local property of affine schemes. The induced property of morphisms of geometric stacks is local.
\end{lemma}
\begin{proof}
	\begin{enumerate}
		\item Ok
		\item Ok
		\item By \ref{lemma:local} we only need to show stability under basechange. Let $Z \to W$ have $P$, Given $Y \to W$ a geometric cover. We want to show that a basechagne $Y \times_W Z \to Y$ has $P$. The idea is to construct a common atlas of $Z \to W$ and its basechange. Choose an atlas $\tilde Y \to Y$. Then $\tilde Y \times_W Z \to Y \times_W Z$ is a geometric cover: It is a basechange of $\tilde Y \to Y$, because the outer diagram is a pullback
		% https://q.uiver.app/#q=WzAsNixbMCwwLCJcXHRpbGRlIFkgXFx0aW1lc19XIFoiXSxbMSwwLCJZIFxcdGltZXNfVyBaIl0sWzAsMSwiXFx0aWxkZSBZIl0sWzEsMSwiWSJdLFsyLDAsIloiXSxbMiwxLCJXIl0sWzAsMl0sWzAsMV0sWzIsM10sWzEsM10sWzMsNV0sWzEsNF0sWzQsNV0sWzEsNSwiIiwxLHsic3R5bGUiOnsibmFtZSI6ImNvcm5lci1pbnZlcnNlIn19XSxbMCwzLCIiLDEseyJzdHlsZSI6eyJuYW1lIjoiY29ybmVyLWludmVyc2UifX1dXQ==
		\[\begin{tikzcd}
			{\tilde Y \times_W Z} & {Y \times_W Z} & Z \\
			{\tilde Y} & Y & W
			\arrow[from=1-1, to=1-2]
			\arrow[from=1-1, to=2-1]
			\arrow["\ulcorner"{anchor=center, pos=0.125}, draw=none, from=1-1, to=2-2]
			\arrow[from=1-2, to=1-3]
			\arrow[from=1-2, to=2-2]
			\arrow["\ulcorner"{anchor=center, pos=0.125}, draw=none, from=1-2, to=2-3]
			\arrow[from=1-3, to=2-3]
			\arrow[from=2-1, to=2-2]
			\arrow[from=2-2, to=2-3]
		\end{tikzcd}\]
		Now choose any geometric atlas $S \to \tilde Y \times_W Z$. By composition this induce a map $S \to \tilde Y$: 
		It is both an atlas of the $P$-map $Z \to W$ and of $ Y\times_W Z \to Y$. So by \ref{lemma:atlasOfMap} $S \to \tilde Y$ has $P$ and thus $Y \times_W Z \to Y$ has $P$. 
		\item geometric covers have $P$ and we have proven point 2., so one direction is clear.  Now assume 
		%https://q.uiver.app/#q=WzAsMyxbMCwwLCJYIl0sWzEsMCwiWSJdLFsxLDEsIloiXSxbMCwxLCJmIl0sWzEsMiwiZyJdLFswLDIsImgiLDJdXQ==
		\[\begin{tikzcd}
			X & Y \\
			& Z
			\arrow["f", from=1-1, to=1-2]
			\arrow["h"', from=1-1, to=2-2]
			\arrow["g", from=1-2, to=2-2]
		\end{tikzcd}\]
		Such that $f$ is a geometric cover and $h$ has $P$. \\
		We first reduce to the case where $Z$ is affine. Choose a geometric atlas $\tilde Z \to Z$. Then take the pullbacks
		% https://q.uiver.app/#q=WzAsNixbMiwwLCJcXHRpbGRlIFoiXSxbMiwxLCJaIl0sWzEsMCwiWSciXSxbMSwxLCJZIl0sWzAsMCwiWCciXSxbMCwxLCJYIl0sWzIsM10sWzMsMV0sWzAsMV0sWzIsMF0sWzIsMSwiIiwxLHsic3R5bGUiOnsibmFtZSI6ImNvcm5lci1pbnZlcnNlIn19XSxbNSwzXSxbNCw1XSxbNSwxLCJQIiwxLHsiY3VydmUiOjJ9XSxbNCwyXSxbNCwzLCIiLDEseyJzdHlsZSI6eyJuYW1lIjoiY29ybmVyLWludmVyc2UifX1dXQ==
		\[\begin{tikzcd}
			{X'} & {Y'} & {\tilde Z} \\
			X & Y & Z
			\arrow[from=1-1, to=1-2]
			\arrow[from=1-1, to=2-1]
			\arrow["\ulcorner"{anchor=center, pos=0.125}, draw=none, from=1-1, to=2-2]
			\arrow[from=1-2, to=1-3]
			\arrow[from=1-2, to=2-2]
			\arrow["\ulcorner"{anchor=center, pos=0.125}, draw=none, from=1-2, to=2-3]
			\arrow[from=1-3, to=2-3]
			\arrow[from=2-1, to=2-2]
			\arrow["P"{description}, curve={height=12pt}, from=2-1, to=2-3]
			\arrow[from=2-2, to=2-3]
		\end{tikzcd}\]
		$X' \to Y'$ is a geometric cover and By 3. $X' \to \tilde Z$ has $P$. \\
		So we may assume that $Z$ is affine. Then take a geometric atlas $\tilde X \to X$. The map $Y \to Z$ has the atlas $\tilde X \to X \to Z$ which has $P$ by stability under composition. Hence $Y \to Z$ has $P$.
	
		
	\end{enumerate}
\end{proof}
\section{Flat}
Consider a lex modality $L$.
\begin{definition}
	A subset of affines $\bP$ \emph{flattens} $L$ if
	\begin{itemize}
		\item $1 \in \bP$
		\item $\bP$ is stable under finite sums
		\item 	 the pretopology $\bT := \{ X \in \bP \ | \ L \| X \| \}$ induces the lex modality $L$.
	\end{itemize}

%	\begin{itemize}
%		\item Either $X$ is contractible
%		\item Or Whenever we find $\Spec B \in \bT$ such that $\Spec B \to L \|X\|$
%	\end{itemize}
%	generates $L$.
\end{definition}

Things in $\bP$ we call 'flat'.
\begin{example}
	For the Zariski topology, the flat affines are the finite sums of principal opens.
\end{example}
\begin{example}
	For the fppf topology, flat is flat
\end{example}
\begin{example}
	For the etale topology, flat affines are the formally \etale + flats.
\end{example}
\begin{lemma}
	If $\Spec A \in \bP$, then $\| \Spec A\|_\bT$ is geometric.
\end{lemma}
\begin{lemma}
	If $X$ is a covering stack and $Y$ a flat geometric stack, then $X + Y$ is covering
\end{lemma}
\begin{proof}
	Let $\bT \ni \tilde X \to X, \tilde Y \to Y$ be geometric atlasses. Then $\tilde X+ \tilde Y$ is flat and $\bT$-merely inhabited, hence in the topology.
\end{proof}


\begin{lemma}
	Given $a : A$ , $I \subset R$, s.th. $\forall x : \Spec A , a(x) \in I$. Then $a \in IA$.
\end{lemma}
\begin{prop}
	An $R$-algebra $A$ is flat iff for all finitely generated ideals $I$ the natural $A$-linear map
	\begin{align*}
	\phi: A \otimes_R I &\to I^{\Spec A} \\
	a \otimes m &\mapsto a(\bullet) \cdot m
	\end{align*}
	is injective.
\end{prop}
\begin{proof}

	If $\phi$ is injective: By lombardi quitte its enough to check the flatness conditions for inclusions $I \hookrightarrow R$. then from the commutativity of
	% https://q.uiver.app/#q=WzAsNCxbMCwwLCJBIFxcb3RpbWVzX1IgTSJdLFsxLDAsIk1ee1xcU3BlYyBBfSJdLFsxLDEsIk5ee1xcU3BlYyBBfSJdLFswLDEsIkEgXFxvdGltZXNfUiBOIl0sWzEsMiwiIiwwLHsic3R5bGUiOnsidGFpbCI6eyJuYW1lIjoiaG9vayIsInNpZGUiOiJ0b3AifX19XSxbMCwzXSxbMywyXSxbMCwxLCIiLDEseyJzdHlsZSI6eyJ0YWlsIjp7Im5hbWUiOiJob29rIiwic2lkZSI6InRvcCJ9fX1dXQ==
	\[\begin{tikzcd}
		{A \otimes_R M} & {M^{\Spec A}} \\
		{A \otimes_R N} & {N^{\Spec A}}
		\arrow[hook, from=1-1, to=1-2]
		\arrow[from=1-1, to=2-1]
		\arrow[hook, from=1-2, to=2-2]
		\arrow[from=2-1, to=2-2]
	\end{tikzcd}\]
we deduce that the left vertical map is injective. \\
Conversely, from the commutative diagram % https://q.uiver.app/#q=WzAsNCxbMCwwLCJBIFxcb3RpbWVzX1IgSSJdLFsxLDAsIkEiXSxbMCwxLCJJXntcXFNwZWMgQX0iXSxbMSwxLCJSXntcXFNwZWMgQX0iXSxbMSwzLCJcXHNpbWVxIl0sWzAsMSwiIiwwLHsic3R5bGUiOnsidGFpbCI6eyJuYW1lIjoiaG9vayIsInNpZGUiOiJ0b3AifX19XSxbMCwyXSxbMiwzXV0=
\[\begin{tikzcd}
	{A \otimes_R I} & A \\
	{I^{\Spec A}} & {R^{\Spec A}}
	\arrow[hook, from=1-1, to=1-2]
	\arrow[from=1-1, to=2-1]
	\arrow["\simeq", from=1-2, to=2-2]
	\arrow[from=2-1, to=2-2]
\end{tikzcd}\]
we deduce that the left vertical map is injective.


\end{proof}

%The definition is reasonable because the following
\end{document}

